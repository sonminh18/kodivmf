name: Build and Deploy Kodi Addon

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get addon version
      id: addon_version
      run: |
        VERSION=$(grep '<addon' plugin.video.vietmediaF/addon.xml | grep -o 'version="[^"]*"' | cut -d'"' -f2)
        if [ -z "$VERSION" ]; then
          echo "Error: Could not extract version from addon.xml"
          exit 1
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Addon version: $VERSION"
        
    - name: Create addon zip
      run: |
        # Create addon zip file
        cd plugin.video.vietmediaF
        zip -r ../plugin.video.vietmediaF-${{ steps.addon_version.outputs.version }}.zip . -x "*.git*" "*.DS_Store*" "__pycache__/*" "*.pyc"
        cd ..
        
        # Also create a zip without version for latest download
        cp plugin.video.vietmediaF-${{ steps.addon_version.outputs.version }}.zip plugin.video.vietmediaF.zip
        
        # Create checksums
        sha256sum plugin.video.vietmediaF-${{ steps.addon_version.outputs.version }}.zip > plugin.video.vietmediaF-${{ steps.addon_version.outputs.version }}.zip.sha256
        sha256sum plugin.video.vietmediaF.zip > plugin.video.vietmediaF.zip.sha256
        
    - name: Create repository structure
      run: |
        # Create Kodi repository structure
        mkdir -p docs/plugin.video.vietmediaF
        
        # Copy addon.xml to repository
        cp plugin.video.vietmediaF/addon.xml docs/plugin.video.vietmediaF/
        
        # Copy icon and fanart if they exist
        if [ -f plugin.video.vietmediaF/icon.png ]; then
          cp plugin.video.vietmediaF/icon.png docs/plugin.video.vietmediaF/
        fi
        if [ -f plugin.video.vietmediaF/fanart.png ]; then
          cp plugin.video.vietmediaF/fanart.png docs/plugin.video.vietmediaF/
        fi
        
        # Move zip files to docs directory
        mv plugin.video.vietmediaF*.zip* docs/
        
    - name: Generate repository XML
      run: |
        cat > docs/addons.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <addons>
        EOF
        
        # Extract addon info and add to addons.xml
        sed '1d;$d' plugin.video.vietmediaF/addon.xml >> docs/addons.xml
        
        cat >> docs/addons.xml << 'EOF'
        </addons>
        EOF
        
        # Generate MD5 hash
        md5sum docs/addons.xml | cut -d' ' -f1 > docs/addons.xml.md5
        
    - name: Create download page
      run: |
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="vi">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>VietmediaF Kodi Addon Repository</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    background-color: #f5f5f5;
                }
                .header {
                    text-align: center;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 30px;
                    border-radius: 10px;
                    margin-bottom: 30px;
                }
                .addon-card {
                    background: white;
                    padding: 25px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    margin-bottom: 20px;
                }
                .download-btn {
                    display: inline-block;
                    background: #4CAF50;
                    color: white;
                    padding: 12px 24px;
                    text-decoration: none;
                    border-radius: 5px;
                    margin: 5px;
                    transition: background 0.3s;
                }
                .download-btn:hover {
                    background: #45a049;
                }
                .version-btn {
                    background: #2196F3;
                }
                .version-btn:hover {
                    background: #1976D2;
                }
                .install-guide {
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    padding: 15px;
                    border-radius: 5px;
                    margin-top: 20px;
                }
                .footer {
                    text-align: center;
                    margin-top: 30px;
                    padding: 20px;
                    color: #666;
                }
                .repo-url {
                    background: #e9ecef;
                    padding: 10px;
                    border-radius: 5px;
                    font-family: monospace;
                    margin: 10px 0;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üé¨ VietmediaF Kodi Addon</h1>
                <p>Addon t·ªïng h·ª£p link fshare ƒë∆∞·ª£c chia s·∫ª tr√™n Internet</p>
                <p>Version: <strong>${{ steps.addon_version.outputs.version }}</strong></p>
            </div>
            
            <div class="addon-card">
                <h2>üì• T·∫£i xu·ªëng</h2>
                <p>Ch·ªçn m·ªôt trong c√°c t√πy ch·ªçn t·∫£i xu·ªëng b√™n d∆∞·ªõi:</p>
                
                <a href="plugin.video.vietmediaF.zip" class="download-btn">
                    üì¶ T·∫£i xu·ªëng phi√™n b·∫£n m·ªõi nh·∫•t
                </a>
                
                <a href="plugin.video.vietmediaF-${{ steps.addon_version.outputs.version }}.zip" class="download-btn version-btn">
                    üè∑Ô∏è T·∫£i xu·ªëng v${{ steps.addon_version.outputs.version }}
                </a>
                
                <div class="install-guide">
                    <h3>üìñ H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t</h3>
                    <ol>
                        <li>T·∫£i xu·ªëng file ZIP c·ªßa addon</li>
                        <li>M·ªü Kodi v√† v√†o <strong>Settings > Add-ons</strong></li>
                        <li>Ch·ªçn <strong>Install from zip file</strong></li>
                        <li>Duy·ªát v√† ch·ªçn file ZIP ƒë√£ t·∫£i xu·ªëng</li>
                        <li>Ch·ªù th√¥ng b√°o c√†i ƒë·∫∑t th√†nh c√¥ng</li>
                        <li>Addon s·∫Ω xu·∫•t hi·ªán trong <strong>Video Add-ons</strong></li>
                    </ol>
                </div>
                
                <div class="install-guide">
                    <h3>üîó C√†i ƒë·∫∑t qua Repository URL</h3>
                    <p>Th√™m repository n√†y v√†o Kodi ƒë·ªÉ nh·∫≠n c·∫≠p nh·∫≠t t·ª± ƒë·ªông:</p>
                    <div class="repo-url">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/</div>
                </div>
            </div>
            
            <div class="addon-card">
                <h2>‚ÑπÔ∏è Th√¥ng tin Addon</h2>
                <ul>
                    <li><strong>T√™n:</strong> VietmediaF</li>
                    <li><strong>Phi√™n b·∫£n:</strong> ${{ steps.addon_version.outputs.version }}</li>
                    <li><strong>T∆∞∆°ng th√≠ch:</strong> Kodi 21+</li>
                    <li><strong>Ng√¥n ng·ªØ:</strong> Ti·∫øng Vi·ªát</li>
                    <li><strong>M√¥ t·∫£:</strong> Addon t·ªïng h·ª£p link fshare ƒë∆∞·ª£c chia s·∫ª tr√™n Internet</li>
                </ul>
            </div>
            
            <div class="addon-card">
                <h2>‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng</h2>
                <p>Addon n√†y ch·ªâ t·ªïng h·ª£p c√°c link ƒë∆∞·ª£c chia s·∫ª c√¥ng khai tr√™n Internet. 
                Ng∆∞·ªùi d√πng c·∫ßn c√≥ t√†i kho·∫£n VIP c·ªßa Fshare ho·∫∑c 4share ƒë·ªÉ s·ª≠ d·ª•ng.</p>
                <p>T√°c gi·∫£ kh√¥ng ch·ªãu tr√°ch nhi·ªám v·ªÅ n·ªôi dung ƒë∆∞·ª£c hi·ªÉn th·ªã trong addon.</p>
            </div>
            
            <div class="footer">
                <p>üîÑ T·ª± ƒë·ªông c·∫≠p nh·∫≠t t·ª´ GitHub Actions</p>
                <p>üìÖ C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: $(date '+%d/%m/%Y %H:%M:%S UTC')</p>
            </div>
        </body>
        </html>
        EOF
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        path: ./docs
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kodi-addon-${{ steps.addon_version.outputs.version }}
        path: |
          docs/plugin.video.vietmediaF*.zip
          docs/plugin.video.vietmediaF*.sha256
        retention-days: 90